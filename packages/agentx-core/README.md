# @deepractice-ai/agentx-core

**AgentX Core** - Agent Lifecycle and Session Management for AI Agents.

## Overview

AgentX Core provides the **stateful layer** on top of the stateless Engine. It manages Agent instances (like Spring's ApplicationContext manages Beans) and Session persistence.

**Key Design**:

- `AgentContext` - Runtime context (internal fields + merged config)
- `AgentDriver` - Stateless driver interface (receives context)
- `AgentDefinition` - Static agent definition
- `Agent` - Runtime instance
- `AgentContainer` - Instance lifecycle manager

## Features

- **Stateless Driver** - Driver receives context, no internal state
- **Context-based Config** - Config merged into AgentContext at runtime
- **Agent Lifecycle** - `running` / `destroyed` state management
- **Session Management** - Message persistence with agent association
- **Type-safe Events** - Subscribe to agent events with type safety

## Installation

```bash
pnpm add @deepractice-ai/agentx-core
```

## Quick Start

### Define a Stateless Driver

```typescript
import type { AgentDriver, AgentContext } from "@deepractice-ai/agentx-core";

// Driver is STATELESS - all config comes from context
const claudeDriver: AgentDriver<{ apiKey: string; model?: string }> = {
  name: "Claude",
  async *receive(message, context) {
    // Get config from context
    const client = new Anthropic({ apiKey: context.apiKey });
    const stream = client.messages.stream({
      model: context.model || "claude-sonnet-4-20250514",
      messages: [{ role: "user", content: message.content }],
    });
    for await (const event of stream) {
      yield transformEvent(event);
    }
  },
};
```

### Create an Agent

```typescript
import { initializeCore, createAgent, destroyAgent } from "@deepractice-ai/agentx-core";
import { AgentEngine } from "@deepractice-ai/agentx-engine";

// 1. Initialize core (once per process)
const engine = new AgentEngine({ driver: engineDriver });
initializeCore(engine);

// 2. Create agent with config (merged into context)
const agent = createAgent(
  { name: "Claude", driver: claudeDriver },
  { apiKey: "sk-xxx", model: "claude-sonnet-4-20250514" }
);

// 3. Subscribe to events
agent.on("text_delta", (event) => {
  process.stdout.write(event.data.text);
});

// 4. Send message
await agent.receive("Hello!");

// 5. Clean up
await destroyAgent(agent.agentId);
```

### With Sessions

```typescript
import {
  createSession,
  associateAgent,
  addMessage,
  createMessage,
} from "@deepractice-ai/agentx-core";

// Create a session
let session = createSession("My Chat");

// Associate with an agent
session = associateAgent(session, agent.agentId);

// Add messages
const userMsg = createMessage(agent.agentId, "user", "Hello!");
session = addMessage(session, userMsg);
```

## Core Interfaces

### AgentContext

Runtime context that merges internal fields with config:

```typescript
interface AgentContextBase {
  readonly agentId: string; // Generated by Core
  readonly createdAt: number; // Generated by Core
}

// Full context = base + config
type AgentContext<TConfig> = AgentContextBase & Readonly<TConfig>;

// Example context at runtime:
// {
//   agentId: "agent_abc123",
//   createdAt: 1732617600000,
//   apiKey: "sk-xxx",        // from config
//   model: "claude-3",       // from config
// }
```

### AgentDriver

Stateless driver that receives context:

```typescript
interface AgentDriver<TConfig = Record<string, unknown>> {
  readonly name: string;
  readonly description?: string;
  receive(message: UserMessage, context: AgentContext<TConfig>): AsyncIterable<StreamEventType>;
}
```

### AgentPresenter

Output adapter:

```typescript
interface AgentPresenter {
  readonly name: string;
  readonly description?: string;
  present(agentId: string, output: AgentOutput): void | Promise<void>;
}
```

### AgentDefinition

Static agent definition:

```typescript
interface AgentDefinition<TConfig = Record<string, unknown>> {
  name: string;
  description?: string;
  driver: AgentDriver<TConfig>;
  presenters?: AgentPresenter[];
}
```

## Type-Based Event Subscription

Agent supports type-based event subscription for better performance:

```typescript
// Subscribe to specific event type
agent.on("text_delta", (event) => {
  process.stdout.write(event.data.text);
});

// Subscribe to multiple types
agent.on(["message_start", "message_stop"], (event) => {
  console.log(event.type);
});

// Subscribe to all events
agent.on((event) => {
  console.log(event.type);
});

// Unsubscribe
const unsubscribe = agent.on("text_delta", handler);
unsubscribe();
```

## Agent Lifecycle

```
createAgent()
     │
     ▼
┌─────────────────────────────────────────────────────────────┐
│                      RUNNING                                 │
│                                                              │
│  States:                                                     │
│  ┌─────────┐  receive()  ┌────────────┐  tool_call  ┌─────┐ │
│  │  idle   │ ─────────→  │ responding │ ─────────→  │await│ │
│  └─────────┘  ←─────────  └────────────┘  ←─────────  │tool│ │
│       ▲       message_stop       ▲       tool_result └─────┘ │
│       │                          │                           │
│       └──────────────────────────┘                           │
│              abort() / interrupt()                           │
└─────────────────────────────────────────────────────────────┘
     │
     │ destroy()
     ▼
┌─────────────────────────────────────────────────────────────┐
│                     DESTROYED                                │
└─────────────────────────────────────────────────────────────┘
```

## Related Packages

- **[@deepractice-ai/agentx-framework](../agentx-framework)** - defineAgent, ConfigSchema
- **[@deepractice-ai/agentx-engine](../agentx-engine)** - Stateless event processing engine
- **[@deepractice-ai/agentx-event](../agentx-event)** - Event type definitions

## License

MIT
